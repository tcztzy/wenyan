# Wenyan.py 語法樹（AST）與 Python AST 轉譯規範（草案）

本文件定義 `wenyan.py` 在 **詞法（`詞法分析器`）之後** 的兩件事：

1) 文言源碼 → Wenyan AST（本專案內部語法樹；節點類名/欄位名以繁體中文為主，便於未來自舉）。
2) Wenyan AST → Python `ast`（標準庫）之轉譯規則（供 `compile()` 執行）。

說明：
- 詞法規則與 token 行為以 `SPEC.md` 為準。
- `src/` 為參考實作（不作為規範來源）；本文件是 `wenyan.py` 的規範。

## 0. 範圍與目標（MVP）

第一階段（MVP）目標：可覆蓋最小可執行子集，至少能正確編譯/執行：
- `examples/helloworld.wy`
- `examples/fizzbuzz.wy`（僅作語義參考；MVP 不強制跑完所有 examples）

MVP 必須支援：
- 變數宣告/初始化：`吾有/今有`、`有`
- 命名：`名之曰`
- 輸出：`書之`
- 算術：`加/減/乘/除`、`所餘幾何`（餘數）
- 比較：`等於/不等於/大於/小於/不大於/不小於`
- 布林：`陰/陽`、`變`
- 邏輯：`中有陽乎/中無陰乎`
- 控制流：`若/若非/或若/者/也/云云`、`恆為是`、`乃止`、`乃止是遍`
- 賦值：`昔之 … 者 今 … 是矣`

## 0.1 內建型別（builtin types）

本實作定義文言內建型別（對應宣告語句中的「數/言/列/爻/物/術/元」），其目的為：
- 自舉：未來 Wenyan 版本的核心語義可直接映射到這些型別。
- 一致性：避免直接把語義散落在轉譯器裡。

MVP 先定義以下型別與預設值：
- `數`：Python `int`/`float`（視字面量是否含小數點）。
- `言`：Python `str`。
- `爻`：Python `bool`（陰=False，陽=True）。
- `列`：MVP 先以 Python `list` 表示（內部 0-based），由轉譯器處理文言的 1-based 下標語義；完整容器 API（`充/銜/其餘` 等）後續補齊。
- `物`：MVP 先以 Python `dict` 表示；未來可抽象為與 `列` 統一的容器型別（視自舉需求調整）。
- `術`：Python `callable`（MVP 允許先用占位函數；完整函數語義後續補齊）。
- `元`：Python `object`（MVP 以 `None` 作為空值/未初始化）。

非 MVP（後續擴充）：
- `術`（函數）、`列/物`（容器完整語義）、`吾嘗觀`（import）、`姑妄行此`（try/catch）、macro 等。

## 1. 詞法輸出（Token）

`詞法分析器` 產出 `符號`：
- `類别`: `str`
- `值`: `str | None`
- `位置`: `slice`

約定：
- **關鍵字 token**：`值 is None`，且 `類别` 為關鍵字本身（例如 `"吾有"`、`"書之"`、`"若"`）。
- **值 token**：
  - 名（identifier）：`類别 == "名"`，`值` 為 `「…」` 內文
  - 言（string literal）：`類别 == "言"`，`值` 為字面量內容（已做最小轉義）
  - 數（number literal）：`類别 == "數"`，`值` 為十進位字串
  - 數據（raw data）：`類别 == "數據"`，`值` 為原樣字串（MVP 暫不使用）

## 2. 核心語義：暫存棧（「其」）

文言語句之間存在一個隱式「暫存棧」（可視為一串暫存值）：
- 產生值的語句會將結果推入暫存棧頂（top）。
- `其`：取暫存棧頂之值，並**清空暫存棧**（與 `src/` 參考實作一致；避免暫存值意外累積）。
- `書之`：輸出暫存棧中全部值（從底到頂），然後清空暫存棧。
- `噫`：直接清空暫存棧（不輸出）。
- `名之曰`：將暫存棧頂的若干值綁定到新名字（再從棧中彈出）。

MVP 約束：
- `名之曰` 若給出多個名字（`名之曰「甲」曰「乙」…`），則依序綁定 **從棧頂往下** 的值：
  - 最後一個名字綁定棧頂；倒數第二個名字綁定次頂；以此類推。
  - 綁定完成後，彈出相同數量的暫存值。

## 3. Wenyan AST（節點定義）

AST 為「語句序列 + 區塊巢狀」；節點類名/欄位名使用繁體中文。

所有節點都必須帶有：
- `位置: slice`（對應源碼片段；用於錯誤定位）

### 3.1 值（表達式）

MVP 的值分三種：
- `名值(名: str)`
- `言值(文: str)`（已轉義後內容，不含引號）
- `數值(文: str)`（十進位字串，後續由轉譯器決定用 `int` 或 `float`）
- `其值()`（取暫存棧頂並清空暫存棧）

（註：`陰/陽` 先作為語句中的值處理，細節由 parser 決定。）

### 3.2 語句（Statements）

#### 變數宣告
- `宣告句(數量: int, 類型: str, 初值列: list[值], 公開: bool)`
  - 對應：
    - `吾有/今有`：`公開` 分別為 `False/True`
    - 例如：`吾有二數。曰一。曰二。`
  - 轉譯後：建立對應數量的 Python 變數（若未命名則編譯器生成臨時變數並推入暫存棧）。

- `初始化句(類型: str, 初值: 值, 名: str | None)`
  - 對應：`有 <類型> <值> [名之曰「…」]`

#### 命名/賦值/輸出
- `命名句(名列: list[str])`
  - 對應：`名之曰「甲」。曰「乙」。…`

- `昔今句(左名: str, 右值: 值)`
  - 對應：`昔之「甲」者。今 <值> 是矣`
  - MVP 暫不支援下標賦值與刪除（後續擴充 `之` / `不復存矣`）。

- `書之句()`
- `噫句()`

#### 運算/取值（會產生暫存值）
- `算術句(算: str, 左: 值, 右: 值)`
  - `算` ∈ `{"+","-","*","/","%","||","&&"}`
  - 對應：
    - `加/減/乘/除 <甲> 以/於 <乙>`
    - `除 … 所餘幾何` → `%`
    - `夫 <甲> <乙> 中有陽乎/中無陰乎` → `||/&&`

- `變句(值: 值)`：對應 `變 <值>`

#### 控制流（區塊）
- `若句(條件: list[值|運算子], 然: list[句], 否則: list[句], 另若列: list[若句])`
  - MVP 先允許最常見形式：
    - `若 <名|其|數|言> 者 … [若非 …] … 也/云云`
    - `若 <名> 等於 <值> 者 乃止 也`（單句塊）
  - `條件` 的完整表達式規格後續補齊（優先與 `wy.spec` 對齊）。

- `恆為是句(體: list[句])`：對應 `恆為是 … 云云/也`
- `乃止句()`：break
- `乃止是遍句()`：continue

## 4. Wenyan AST → Python AST（標準庫 `ast`）

### 4.1 基本原則
- 轉譯輸出為 `ast.Module`，可直接交給 `compile()`。
- 變數名：
  - 若為合法 Python identifier，原樣保留（包含中文）。
  - 否則（含空白/符號等），MVP 直接報錯（後續可加入轉碼/映射）。
- 暫存棧：
  - 由轉譯器在 Python 端用一組臨時變數與 Python list 來模擬（例如 `__暫存: list[object]`）。
  - 由於 `其` 具有「取值並清空」的副作用，轉譯器應產生輔助函式（例如 `__其()`）：
    - `__其()` 回傳 `__暫存[-1]`，並呼叫 `__暫存.clear()`。
    - `其` 轉譯為 `__其()`。

### 4.2 轉譯規則（MVP）
- `宣告句`：
  - 生成 Python `Assign`（必要時建立臨時名）
  - 若未命名：把臨時名 `Name` 推入 `__暫存.append(...)`
- `初始化句`：同上（必有初值）
- `命名句`：
  - 依規則把 `__暫存` 的值彈出並賦給對應名字（`Assign`）
- `書之句`：
  - `print(*__暫存)` 然後 `__暫存.clear()`
- `噫句`：
  - `__暫存.clear()`
- `算術句` / `變句`：
  - 計算結果先賦給新臨時變數，再 `__暫存.append(臨時變數)`
- `昔今句`：
  - `左名 = <右值>`
- `若句`：
  - 生成 `ast.If(test=..., body=..., orelse=...)`
- `恆為是句`：
  - 生成 `ast.While(test=True, body=..., orelse=[])`
- `乃止句` / `乃止是遍句`：
  - `ast.Break` / `ast.Continue`

## 5. 待確認/待補齊

- `條件` 的完整表達式語法（含 `之/之長`、複合比較、邏輯優先序）如何與 `wy.spec` 對齊。
- 容器（列/物）的 MVP 表示法：用 Python 原生 `list/dict` 或自訂 `容器`。
- 函數（術）/import/try-catch 的語義與 AST 形狀。
