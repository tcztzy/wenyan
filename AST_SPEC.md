# Wenyan.py 語法樹（AST）與 Python AST 轉譯規範（草案）

本文件定義 `wenyan.py` 在 **詞法（`詞法分析器`）之後** 的兩件事：

1) 文言源碼 → Wenyan AST（本專案內部語法樹；節點類名/欄位名以繁體中文為主，便於未來自舉）。
2) Wenyan AST → Python `ast`（標準庫）之轉譯規則（供 `compile()` 執行）。

說明：
- 詞法規則與 token 行為以 `SPEC.md` 為準。
- `src/` 為參考實作（不作為規範來源）；本文件是 `wenyan.py` 的規範。

## 0. 範圍與目標（完整子集）

本版本目標：支援 **Python 版可執行子集**，以覆蓋所有非 JS-only 範例與標準庫：

必須支援：
- 變數宣告/初始化：`吾有/今有`、`有`
- 命名：`名之曰`
- 輸出：`書之`
- 算術：`加/減/乘/除`、`所餘幾何`（餘數）
- 比較：`等於/不等於/大於/小於/不大於/不小於`
- 布林：`陰/陽`、`變`
- 邏輯：`中有陽乎/中無陰乎`
- 控制流：`若/若非/或若/者/也/云云`、`恆為是`、`為是…遍`、`乃止`、`乃止是遍`
- 賦值：`昔之 … 者 今 … 是/是矣/是也`（含下標與刪除）
- 函數：`吾有/今有…術` 定義、`施/以施` 呼叫、`取` 參數擷取、`乃得/乃得矣/乃歸空無` 返回
- 容器：`列/物`，`充`（push）、`銜`（concat）、`之/之長/其餘`（下標/長度/切片）
- 物定義：`其物如是 … 是謂 … 之物也`
- for-each：`凡 … 中之 …`
- 匯入：`吾嘗觀 … 之書 … 方悟 … 之義`
- 例外：`姑妄行此/如事不諧/豈…之禍歟/不知何禍歟/乃作罷`、`嗚呼…之禍`
- 宏與註釋：`或云/蓋謂`、`注曰/疏曰/批曰`

限制：
- 仍以 Python 可執行子集為準；無法轉為 Python 表達式之語句（典型為 JS 特有片段）會報文法錯。
- `畫譜` 在 Python 目標提供 `turtle` 相容子集（`備紙/裱畫/落筆/運筆/蘸色/調色/蘸水/擇筆/提筆/設色`），
  並以 `WENYAN_TURTLE_HEADLESS=1` 支援無視窗執行。

## 0.1 內建型別（builtin types）

本實作定義文言內建型別（對應宣告語句中的「數/言/列/爻/物/術/元」），其目的為：
- 自舉：未來 Wenyan 版本的核心語義可直接映射到這些型別。
- 一致性：避免直接把語義散落在轉譯器裡。

本實作定義以下型別與預設值：
- `數`：Python `int`/`float`（視字面量是否含小數點）。
- `言`：Python `str`。
- `爻`：Python `bool`（陰=False，陽=True）。
- `列`：Python `list` 表示（內部 0-based），轉譯器負責文言 1-based 下標語義。
- `物`：Python `dict` 表示；`物之「鍵」者` 對應 dict key。
- `術`：Python `callable`；轉譯器會為文言術設定 `__文言術參數數__` 以支援 curry/partial。
- `元`：Python `object`（MVP 以 `None` 作為空值/未初始化）。

補充：
- `JSON.stringify` 以 `json.dumps(..., ensure_ascii=False)` 表示，失敗時 fallback `str(x)`。
- `String.fromCharCode` 對應 `chr(int(x))`。

## 1. 詞法輸出（Token）

`詞法分析器` 產出 `符號`：
- `類别`: `str`
- `值`: `str | None`
- `位置`: `slice`

約定：
- **關鍵字 token**：`值 is None`，且 `類别` 為關鍵字本身（例如 `"吾有"`、`"書之"`、`"若"`）。
- **值 token**：
  - 名（identifier）：`類别 == "名"`，`值` 為 `「…」` 內文
  - 言（string literal）：`類别 == "言"`，`值` 為字面量內容（已做最小轉義）
  - 數（number literal）：`類别 == "數"`，`值` 為十進位字串
  - 數據（raw data）：`類别 == "數據"`，`值` 為原樣字串（可作為原生 Python 表達式）

## 2. 核心語義：暫存棧（「其」）

文言語句之間存在一個隱式「暫存棧」（可視為一串暫存值）：
- 產生值的語句會將結果推入暫存棧頂（top）。
- `其`：取暫存棧頂之值，並**清空暫存棧**（與 `src/` 參考實作一致；避免暫存值意外累積）。
- `書之`：輸出暫存棧中全部值（從底到頂），然後清空暫存棧。
- `噫`：直接清空暫存棧（不輸出）。
- `名之曰`：將暫存棧頂的若干值綁定到新名字（再從棧中彈出）。

補充：
- `乃得矣`：回傳暫存棧頂（等價於 `乃得 其`）。
- `取/以施`：`取` 只影響下一次 `以施` 的取參數數量。
- `名之曰` 若給出多個名字（`名之曰「甲」曰「乙」…`），則依序綁定 **從棧頂往下** 的值：
  - 最後一個名字綁定棧頂；倒數第二個名字綁定次頂；以此類推。
  - 綁定完成後，彈出相同數量的暫存值。

## 3. Wenyan AST（節點定義）

AST 為「語句序列 + 區塊巢狀」；節點類名/欄位名使用繁體中文。

所有節點都必須帶有：
- `位置: slice`（對應源碼片段；用於錯誤定位）

### 3.1 值（表達式）

值分為：
- `名值(名: str)`
- `言值(文: str)`（已轉義後內容，不含引號）
- `數值(文: str)`（十進位字串，後續由轉譯器決定用 `int` 或 `float`）
- `其值()`（取暫存棧頂並清空暫存棧）
 - `其餘值()`（用於 `之其餘` 的 REST 形式）
 - `爻值(真: bool)`（陰/陽）

說明：
- `名值` 若非合法 Python 識別字，轉譯器會嘗試解析為原生 Python 表達式。

（註：`陰/陽` 先作為語句中的值處理，細節由 parser 決定。）

### 3.2 語句（Statements）

#### 變數宣告
- `宣告句(數量: int, 類型: str, 初值列: list[值], 公開: bool)`
  - 對應：
    - `吾有/今有`：`公開` 分別為 `False/True`
    - 例如：`吾有二數。曰一。曰二。`
  - 轉譯後：建立對應數量的 Python 變數（若未命名則編譯器生成臨時變數並推入暫存棧）。

- `初始化句(類型: str, 初值: 值, 名: str | None)`
  - 對應：`有 <類型> <值> [名之曰「…」]`

#### 命名/賦值/輸出
- `命名句(名列: list[str])`
  - 對應：`名之曰「甲」。曰「乙」。…`

- `昔今句(左名: str, 左下標: 值 | None, 右值: 值 | None, 右下標: 值 | None, 刪除: bool)`
  - 對應：`昔之「甲」者。今 <值> 是/是矣/是也`
  - 支援下標賦值與 `不復存矣`

- `書之句()`
- `噫句()`

#### 運算/取值（會產生暫存值）
- `算術句(算: str, 左: 值, 右: 值)`
  - `算` ∈ `{"+","-","*","/","%","||","&&"}`
  - 對應：
    - `加/減/乘/除 <甲> 以/於 <乙>`
    - `除 … 所餘幾何` → `%`
    - `夫 <甲> <乙> 中有陽乎/中無陰乎` → `||/&&`

- `變句(值: 值)`：對應 `變 <值>`
 - `夫句(值: 值)`：對應 `夫 <值>`（推入暫存棧）
 - `之句(容器: 值, 索引: 值)`、`之長句(容器: 值)`

#### 控制流（區塊）
- `若句(條件: list[值|運算子], 然: list[句], 否則: list[句], 另若列: list[若句])`
  - MVP 先允許最常見形式：
    - `若 <名|其|數|言> 者 … [若非 …] … 也/云云`
    - `若 <名> 等於 <值> 者 乃止 也`（單句塊）
  - `條件` 的完整表達式規格後續補齊（優先與 `wy.spec` 對齊）。

- `恆為是句(體: list[句])`：對應 `恆為是 … 云云/也`
- `乃止句()`：break
- `乃止是遍句()`：continue

#### 函數/匯入/容器/物/例外
- `術定義句(名: str, 參數列: list[術參數], 體: list[句], 公開: bool)`
- `施句(術: 值, 參數列: list[值])`、`以施句(術: 值)`、`取句(數量: int)`
- `返回句(值: 值 | None, 取棧: bool, 空無: bool)`（對應 `乃得/乃得矣/乃歸空無`）
- `匯入句(模組: str, 名列: list[str])`
- `列充句(列: 值, 值列: list[值])`、`列銜句(列: 值, 列列: list[值])`
- `物定義句(名: str, 屬性列: list[物屬性])`
- `凡句(容器: 值, 變數名: str, 體: list[句])`
- `試句(體: list[句], 捕捉列: list[捕捉子句])`、`擲句(名: 值, 訊: 值 | None)`
- `註釋句(文: str)`、`宏句(...)`（語義上忽略）

## 4. Wenyan AST → Python AST（標準庫 `ast`）

### 4.1 基本原則
- 轉譯輸出為 `ast.Module`，可直接交給 `compile()`。
- 變數名：
  - 若為合法 Python identifier，原樣保留（包含中文）。
  - 否則（含空白/符號等），嘗試解析為原生 Python 表達式；失敗則報錯。
- 暫存棧：
  - 由轉譯器在 Python 端用一組臨時變數與 Python list 來模擬（例如 `__暫存: list[object]`）。
  - 運行時序言由轉譯器內建（`wenyan.py` 內嵌字串轉 AST），不再依賴外部 `lib/py/序言.py` 載入。
  - 由於 `其` 具有「取值並清空」的副作用，轉譯器應產生輔助函式（例如 `__其()`）：
    - `__其()` 回傳 `__暫存[-1]`，並呼叫 `__暫存.clear()`。
    - `其` 轉譯為 `__其()`。
  - `取`/`以施` 使用 `__取(n)` 或等價邏輯取出暫存棧尾端 `n` 個值。
- 下標（`之` / `昔今`）：
  - 以直接 AST 節點轉譯（`ast.Subscript` + `Assign/Delete`）為原則，不依賴 `__文言取索/__文言置索/__文言刪索` 這類 helper。
  - 對 `列` 保持文言 1-based 語義；`<=0` 索引用內部映射 `__文言負索` 保持既有行為。
- 函數呼叫：
  - `施/以施` 直接轉為 `術(*參數)`；文言術本身由包裝函數實作 curry/partial。
  - 包裝函數在需要時可透過 `__文言呼叫(術, *參數)` 連續套用返回的術值。
- 內建：
  - `JSON.stringify` → `json.dumps(..., ensure_ascii=False)`（失敗時 `str`）。
  - `String.fromCharCode` → `chr(int(x))`。
- 例外：
  - `文言之禍`（Exception）具 `名`/`訊` 欄位，並支援 `__getitem__` 讀取。

### 4.2 轉譯規則（完整）
- `宣告句`：
  - 生成 Python `Assign`（必要時建立臨時名）
  - 若未命名：把臨時名 `Name` 推入 `__暫存.append(...)`
- `初始化句`：同上（必有初值）
- `命名句`：
  - 依規則把 `__暫存` 的值彈出並賦給對應名字（`Assign`）
- `書之句`：
  - `print(*__暫存)` 然後 `__暫存.clear()`
- `噫句`：
  - `__暫存.clear()`
- `算術句` / `變句`：
  - 計算結果先賦給新臨時變數，再 `__暫存.append(臨時變數)`
- `之句`：
  - 直接生成 `ast.Subscript`（讀取）。
  - 字串鍵走字典/容器鍵語義；數字鍵按文言 1-based 轉為 Python 下標。
  - 對 `列` 的 `<=0` 索引與越界讀取，保持既有 `None/負索映射` 行為。
- `昔今句`：
  - 支援下標賦值與刪除，直接生成 `Assign/Delete + ast.Subscript`。
  - 對 `列` 的 `>長度` 賦值先擴容；`<=0` 下標寫入/刪除走 `__文言負索` 映射。
- `若句`：
  - 生成 `ast.If(test=..., body=..., orelse=...)`
- `恆為是句`：
  - 生成 `ast.While(test=True, body=..., orelse=[])`
- `乃止句` / `乃止是遍句`：
  - `ast.Break` / `ast.Continue`
- `術定義句`：
  - 生成「本體函數 + 對外包裝函數」兩個 `FunctionDef`；包裝函數提供 curry/partial。
  - 本體與包裝皆附加 `__文言術參數數__` 屬性，供連續套用時判定參數數量。
  - 依作用域分析插入 `global` / `nonlocal`
- `施句` / `以施句`：
  - 直接生成 `術(*參數)`，並將結果推入 `__暫存`
- `取句`：
  - 影響下一次 `以施` 的參數數量（轉譯器內部狀態）
- `返回句`：
  - `乃得 <值>` → `return <值>`
  - `乃得矣` → `return __其()`
  - `乃歸空無` → `return None`
- `匯入句`：
  - 解析並插入被匯入模組的 AST（同一模組只插入一次）
- `列充句`：
  - `列.append(...)`（多值重複 append）
- `列銜句`：
  - `列 + 列 + ...` 結果推入暫存棧
- `物定義句`：
  - 生成 `dict` literal 並賦值給對應名字
- `凡句`：
  - 生成 `for 變數 in 容器`
- `試句` / `擲句`：
  - `try/except 文言之禍` + 依 `名` 比對分支
  - `嗚呼` → `raise 文言之禍(名, 訊)`
- `註釋句` / `宏句`：
  - 轉譯為空（不產生 runtime 行為）

## 5. 待確認/待補齊

- `條件` 的完整表達式語法（含 `之/之長`、複合比較、邏輯優先序）如何與 `wy.spec` 進一步對齊。
- JS-only 標準庫的 Python 等價實作策略。
