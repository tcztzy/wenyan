# Wenyan.py 词法分析规则（Lexer）

本说明基于 `wenyan.py` 中的 `詞法分析器` 实现，描述其实际 token 化行为（而非理想语法）。

## 1. 扫描策略与优先级
- 从左到右线性扫描源文本。
- 维护四种“正在读取”的状态：字符串字面量、标识符、数值、数据块（數據）。
- 关键优先级（从高到低，且只在不处于更高优先状态时生效）：
  1) 字符串字面量开始/结束符
  2) 忽略符号（空白与顿号/句号）
  3) 标识符起止符
  4) 已在读取数值时继续读取数值
  5) 关键字（按“最长匹配”优先）
  6) 数值开始
  7) 其他文本作为“數據”
- 关键字匹配为**最长匹配优先**，同一位置可匹配多个关键字时取更长的那个。

## 2. Token 类型与含义
- **关键字 token**：`符.類` 为关键字本身，`值` 为 `None`。
- **字符串字面量**：`符.類` 为 `"言"`，`值` 为字面量内容（见第 4 节）。
- **标识符**：`符.類` 为 `"名"`，`值` 为标识符内容（见第 5 节）。
- **数值**：`符.類` 为 `"數"`，`值` 为转换后的十进制字符串。
- **数据块**：`符.類` 为 `"數據"`，`值` 为未被识别为关键字/数值/标识符/字面量的连续文本（见第 7 节）。

每个 token 的 `位置` 是原始源码中的 `slice(start, end)`，用于定位错误或回溯。

## 3. 忽略符号（空白与标点）
- 忽略符号集合：`"。"`、`"、"`、空格、`\t`、`\n`、`\r`。
- 默认情况下，这些字符会被跳过。
- **但若当前正处于“标识符”或“數據”读取中，忽略符号会被追加到该 token 内容里**（数值读取会被终止）。

## 4. 字符串字面量（直值）
- 起始：`「「` 或 `『`。
- 结束：`」」` 或 `』`。
- 支持嵌套：遇到新的起始符会增加嵌套层级，直到层级回到 0 才真正结束。
- 输出时会做最小转义：
  - `"` 被转义为 `\"`
  - 换行符 `\n` 被转义为字面量 `\\n`
- token 类型为 `"言"`，`值` 为转义后的内容（不含分隔符）。
- 如果文件结束时仍未闭合，会抛出 `「「文法」」之禍。言未尽。`（字面量也使用同一消息）。

## 5. 标识符（名）
- 起始：单个 `「`（注意不是 `「「`）。
- 结束：单个 `」`。
- token 类型为 `"名"`，`言` 为中间内容（原样保留，不做转义）。
- 标识符不支持嵌套，遇到首个 `」` 即结束。
- 如果文件结束时仍未闭合，会抛出 `「「文法」」之禍。名未尽。`。

## 6. 数值（num）
- 数值读取基于 **连续的“数值字符”**，字符集合如下：
  - `負 · 又 零 〇 一 二 三 四 五 六 七 八 九 十 百 千 萬 億 兆 京 垓 秭 穰 溝 澗 正 載 極 分 釐 毫 絲 忽 微 纖 沙 塵 埃 渺 漠`
- 只要是上述字符的连续片段，就会被当作“数值候选串”。
- 单位进位与倍率规则：
  - `萬 億 兆 京 垓 秭 穰 溝 澗 正 載 極` 为 **每级 10^4** 进位（即指数每次 +4）：`萬=10^4`，`億=10^8`，`兆=10^12` … `極=10^48`。
  - `分 釐 毫 絲 忽 微 纖 沙 塵 埃 渺 漠` 为 **每级 10^-1**（即指数每次 -1）：`分=10^-1`，`釐=10^-2` … `漠=10^-12`。
- 该候选串会交给状态机校验并转换：
  - 合法则产出十进制字符串。
  - 非法则抛出 `「「文法」」之禍: 非法數`。
- 注意：数值的合法性由状态机决定，**词法层只负责切分与校验**。
- 想把这些数值字符当普通文本时，应放入标识符或字面量，否则会触发数值解析/校验。

## 7. 数据块（數據）
- 当字符既不是字面量/标识符/关键字/数值的一部分时，会被累积为 `"數據"` token。
- 数据块会在以下情况被切断并输出：
  - 遇到关键字（最长匹配成功）
  - 遇到字面量或标识符起始
  - 遇到数值起始
  - 到达文件末尾
- 若在数据块中遇到忽略符号，这些符号也会被保留在数据块内容里。
  - 与忽略符号类似，若数据块已在累积，后续连续普通字符会继续并入同一块。

## 8. 关键字列表（最长匹配优先）
以下字符串会被识别为关键字 token，扫描时按长度从长到短匹配（因此较长关键字优先）：

```
吾有
今有
物之
有
數
列
言
術
爻
物
元
書之
名之曰
施
以施
曰
噫
取
昔之
今
是矣
不復存矣
其
乃得
乃得矣
乃歸空無
是謂
之術也
必先得
是術曰
乃行是術曰
欲行是術
也
云云
凡
中之
恆為是
為是
遍
乃止
乃止是遍
若非
若
者
若其然者
若其不然者
或若
其物如是
之物也
夫
等於
不等於
不大於
不小於
大於
小於
加
減
乘
除
中有陽乎
中無陰乎
變
所餘幾何
以
於
之長
之
充
銜
其餘
陰
陽
吾嘗觀
中
之書
方悟
之義
嗚呼
之禍
姑妄行此
如事不諧
豈
之禍歟
不知何禍歟
乃作罷
或云
蓋謂
注曰
疏曰
批曰
```

需要注意的是 數 列 言 術 爻 分别是 number sequence string function boolean 类型，分析的时候应该把这些`符`的`類`就是`類`。

## 9. 错误处理
- 非法数值：抛出 `「「文法」」之禍`，消息为 `非法數`，并带位置。
- 未闭合标识符或字面量：在文件结束时抛出 `「「文法」」之禍`，消息为 `名未尽`（字面量使用`言未尽`）。
